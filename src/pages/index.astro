---
import Layout from '../layouts/Layout.astro';
import "../styles/global.css";
import { getCollection } from 'astro:content';

const writeups = await getCollection('writeups');
writeups.sort((a, b) => {
  const titleA = a.data.title.toLowerCase();
  const titleB = b.data.title.toLowerCase();
  if (titleA < titleB) return -1;
  if (titleA > titleB) return 1;
  return 0;
});

export const prerender = true;
---

<Layout title="Writeups de la plataforma Hackthebox">
  <main>
    {/* T√≠tulo principal */}
    <div transition:name="writeups-title-group" class="text-center text-7xl text-[#bfff00] font-extrabold mb-12">
      <h1>
        Writeups
        <img src="/code/hacker.svg" alt="Logo" class="w-25 h-25 inline-block align-middle" />
        <span class="block">Hacking</span>
      </h1>
    </div>

    {/* Barra de b√∫squeda sin bot√≥n */}
    <div class="flex justify-center mb-12">
      <input
        type="text"
        id="searchGlobal"
        placeholder="Buscar por nombre, OS, dificultad o skills..."
        autocomplete="off"
        spellcheck="false"
        class="px-4 py-2 rounded bg-[#1f1f1f] text-white w-96 placeholder-gray-400 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-400 text-center"
      />
    </div>

    {/* Secci√≥n de writeups */}
    <section aria-label="Writeups para desarrollar habilidades de hacking √©tico">
      <div class="px-4 mx-auto max-w-screen-xl">
        <div id="writeupsGrid" class="grid gap-6 md:grid-cols-2">
          {
            writeups.map(writeup => {
              const { slug, data } = writeup;
              const { title, os, dificultad, img, plataforma, description, skills } = data;

              return (
                <article 
                  class="flex writeup-item" 
                  data-os={os ?? ''} 
                  data-dificultad={dificultad ?? ''} 
                  data-skills={(skills ?? []).join(' ').toLowerCase()}
                >
                  {/* Imagen */}
                  <a href={`/machines/${slug}`} class="mb-2 xl:mb-0 transition hover:scale-110">
                    <img
                      transition:name={`img-${slug}`}
                      class="mr-10 w-60 rounded"
                      src={`/code/${img}`}
                      alt={title}
                    />
                  </a>
                  
                  {/* Informaci√≥n */}
                  <div class="flex flex-col justify-center pl-3">
                    <a href={`/machines/${slug}`} class="mb-2 xl:mb-0 transition hover:scale-110">
                      <h2 transition:name={`title-${slug}`} class="mb-0.5 text-3xl font-bold leading-tight text-white">
                        {title}
                      </h2>
                    </a>

                    <p class="flex items-center gap-1 mb-2">
                      {os === "Linux" && <img src="/linux_logo.svg" alt="Linux" class="w-6 h-6" />}
                      {os === "Windows" && <img src="/windows_logo.svg" alt="Windows" class="w-6 h-6"/>}
                      {os}
                    </p>

                    <p class="flex items-center gap-1 mb-2">
                      <svg role="img" aria-label="dificultad" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none"
                        stroke={
                          dificultad === "Facil" ? "#1aff1a" :
                          dificultad === "Medio" ? "#ffd700" :
                          dificultad === "Dificil" ? "#ff8c00" :
                          dificultad === "Insane" ? "#ff1a1a" : "#ffffff"
                        }
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                      >
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                      </svg>
                      {dificultad}
                    </p>
                    
                    <p class="flex items-center gap-1 mb-2">
                      <img src="/hackthebox.svg" alt="Hackthebox" class="w-6 h-6"/>{plataforma}
                    </p>

                    <p class="mb-2 text-gray-300 max-w-sm">
                      üíª {description}
                    </p>
                  </div>
                </article>
              )
            })
          }
        </div>
      </div>
    </section>

    <!-- JS: b√∫squeda en tiempo real -->
    <script type="module" is:inline>
      (function () {
        function getEls() {
          return {
            input: document.getElementById('searchGlobal'),
            items: Array.from(document.querySelectorAll('.writeup-item'))
          };
        }

        function filterWriteups(query) {
          var q = (query || '').trim().toLowerCase();
          var els = getEls();
          els.items.forEach(function(item) {
            var title = (item.querySelector('h2')?.innerText || '').toLowerCase();
            var os = (item.dataset.os || '').toLowerCase();
            var dificultad = (item.dataset.dificultad || '').toLowerCase();
            var skills = (item.dataset.skills || '');
            var matches = !q || title.includes(q) || os.includes(q) || dificultad.includes(q) || skills.includes(q);
            item.style.display = matches ? 'flex' : 'none';
          });
        }

        function setUrl(query, replace) {
          var url = new URL(window.location.href);
          if ((query || '').length) {
            url.searchParams.set('search', query);
          } else {
            url.searchParams.delete('search');
          }
          (replace ? history.replaceState : history.pushState).call(history, {}, '', url);
        }

        function readFromUrlAndFilter() {
          var params = new URLSearchParams(location.search);
          var q = params.get('search') || '';
          var els = getEls();
          if (els.input) els.input.value = q;
          filterWriteups(q);
        }

        function attachHandlersOnce() {
          var els = getEls();
          if (!els.input) return;

          // Filtrar mientras escribe
          els.input.addEventListener('input', function() {
            var q = (els.input.value || '').trim().toLowerCase();
            setUrl(q, true);
            filterWriteups(q);
          });
        }

        document.addEventListener('DOMContentLoaded', function() {
          attachHandlersOnce();
          readFromUrlAndFilter();
        });

        window.addEventListener('pageshow', readFromUrlAndFilter);
        window.addEventListener('popstate', readFromUrlAndFilter);

        document.addEventListener('astro:page-load', function () {
          attachHandlersOnce();
          readFromUrlAndFilter();
        });
      })();
    </script>
  </main>

  {/* Footer compacto con fondo #13151a */}
  <footer class="py-1 mt-12 text-gray-400" style="background-color: #13151a;">
    <div class="max-w-screen-xl mx-auto px-4 text-center space-y-0 text-sm">
      <p>&copy; 4jh4ck 2025 - Writeups Hacking. Todos los derechos reservados.</p>
      <p>
        Design by: 4jh4ck, Original Design: 
        <a href="https://github.com/midudev" target="_blank" rel="noopener" class="hover:text-[#bfff00] transition-colors">@Midudev</a>
      </p>
      <p>
        Theme Inspiration: 
        <a href="https://github.com/midudev/astro-5-dev-books" target="_blank" rel="noopener" class="hover:text-[#bfff00] transition-colors">astro-5-dev-books</a>
      </p>
    </div>
  </footer>
</Layout>


